<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basilisk C2 | SOC Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        :root { 
            --bg-body: #0b1120; 
            --bg-panel: #151e32; 
            --accent-primary: #10b981; 
            --accent-danger: #ef4444; 
            --accent-warn: #f59e0b; 
            --text-primary: #e2e8f0; 
            --sidebar-width: 260px; 
        }
        body { background-color: var(--bg-body); color: var(--text-primary); font-family: 'Inter', sans-serif; padding-left: var(--sidebar-width); }
        
        /* Sidebar */
        #sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; left: 0; top: 0; background: var(--bg-panel); border-right: 1px solid #334155; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
        .brand-logo { padding: 24px; border-bottom: 1px solid #334155; background: linear-gradient(180deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%); }
        .brand-title { font-family: 'JetBrains Mono', monospace; font-weight: 800; color: var(--accent-primary); font-size: 1.4rem; letter-spacing: -1px; }
        .nav-link-custom { padding: 14px 24px; color: #94a3b8; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; font-weight: 500; display: flex; align-items: center; }
        .nav-link-custom:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-link-custom.active { background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent); color: var(--accent-primary); border-left-color: var(--accent-primary); }
        
        /* Dashboard Cards */
        #main-content { padding: 30px; }
        .kpi-card { background: var(--bg-panel); border: 1px solid #334155; border-radius: 8px; position: relative; }
        .kpi-value { font-family: 'JetBrains Mono', monospace; font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .kpi-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; font-weight: 700; }
        
        /* DataTables Customization */
        table.dataTable thead th { border-bottom: 2px solid #334155 !important; color: #64748b; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; }
        table.dataTable tbody td { border: none !important; padding: 12px 10px; vertical-align: middle; font-size: 0.9rem; }
        table.dataTable tbody tr { background-color: var(--bg-panel); transition: transform 0.1s; }
        table.dataTable tbody tr:hover { transform: scale(1.002); background-color: #1e293b; }
        
        /* Badges */
        .badge-cyber { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; }
        .badge-crit { background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
        .badge-warn { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }
        .badge-info { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border-color: rgba(59, 130, 246, 0.3); }
        
        .agent-card { background: var(--bg-panel); border: 1px solid #334155; margin-bottom: 10px; border-radius: 8px; transition: 0.2s; cursor: default; }
        .agent-card:hover { border-color: var(--accent-primary); }
        .agent-card.online { border-left: 3px solid var(--accent-primary); }
        .agent-card.offline { border-left: 3px solid var(--accent-danger); opacity: 0.7; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="brand-logo">
            <div class="d-flex justify-content-between align-items-center">
                <span class="brand-title d-flex align-items-center">
                    <img src="/static/logo.ico" alt="Logo" style="height: 40px; width: auto; margin-right: 12px;"> BASILISK
                </span>
                <span class="badge bg-dark border border-success text-success font-monospace" style="font-size: 0.6rem;">v6.8.0</span>
            </div>
            <div class="text-success opacity-75 small mt-2 fw-bold" style="font-size: 0.65rem; letter-spacing: 1px;">ADVANCED THREAT DEFENSE</div>
        </div>
        <div class="mt-4">
            <div class="nav-link-custom active" onclick="switchView('dashboard')"><i class="fa-solid fa-list-check me-3" style="width:20px"></i>Threat Feed</div>
            <div class="nav-link-custom" onclick="switchView('network')"><i class="fa-solid fa-network-wired me-3" style="width:20px"></i>Network Topology</div>
            <div class="nav-link-custom" onclick="Swal.fire('Compliance', 'Select an agent to view audit logs.', 'info')"><i class="fa-solid fa-file-contract me-3" style="width:20px"></i>Compliance</div>
        </div>
        <div class="mt-auto p-4 border-top border-secondary bg-black bg-opacity-25 position-absolute bottom-0 w-100">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <span class="small text-muted text-uppercase fw-bold">System Status</span>
                <span class="badge bg-danger shadow-sm font-monospace" id="server-status-badge">DISCONNECTED</span>
            </div>
            <button class="btn btn-outline-danger btn-sm w-100" onclick="logout()"><i class="fa-solid fa-power-off me-2"></i>LOGOUT</button>
        </div>
    </div>

    <div id="main-content">
        
        <div id="view-dashboard" class="dashboard-section">
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="p-4 kpi-card">
                        <div class="d-flex justify-content-between">
                            <div><div class="kpi-title">Active Agents</div><div class="kpi-value text-success mt-2" id="kpi-agents">0</div></div>
                            <div class="text-success opacity-25"><i class="fa-solid fa-server fa-2x"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-4 kpi-card">
                        <div class="d-flex justify-content-between">
                            <div><div class="kpi-title">Threats (24h)</div><div class="kpi-value text-danger mt-2" id="kpi-critical">0</div></div>
                            <div class="text-danger opacity-25"><i class="fa-solid fa-biohazard fa-2x"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-4 kpi-card">
                        <div class="d-flex justify-content-between">
                            <div><div class="kpi-title">FIM Baseline</div><div class="kpi-value text-info mt-2" id="kpi-fim">SECURE</div></div>
                            <div class="text-info opacity-25"><i class="fa-solid fa-file-shield fa-2x"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 d-grid">
                    <button class="btn btn-outline-secondary border-dashed h-100" id="toggle-charts-btn" onclick="toggleCharts()" style="border-style: dashed; border-width: 2px;">
                        <i class="fa-solid fa-chart-pie me-2"></i>Metrics Visualization
                    </button>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-3">
                    <h6 class="text-muted text-uppercase mb-3 small fw-bold"><i class="fa-solid fa-laptop-code me-2"></i>Infrastructure</h6>
                    <div id="agents-list" class="agent-list-container"></div>
                </div>

                <div class="col-md-9">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0"><i class="fa-solid fa-satellite-dish me-2"></i>Live Incident Feed</h6>
                        <button class="btn btn-outline-secondary btn-sm py-0 px-2" onclick="fetchDashboardData()" title="Force Refresh"><i class="fa-solid fa-rotate-right"></i></button>
                    </div>
                    <table id="incidents-table" class="table w-100">
                        <thead><tr><th>Timestamp</th><th>Agent ID</th><th>Severity</th><th>Type</th><th>Event Details</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="row g-4 mt-2" id="chart-area" style="display:none;">
                 <div class="col-md-12"><hr class="border-secondary opacity-25"></div>
                <div class="col-md-4">
                    <div class="p-3 bg-panel rounded border border-secondary">
                        <h6 class="text-muted small mb-3">Threat Severity Distribution</h6>
                        <div style="height:250px;"><canvas id="chartSeverity"></canvas></div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="p-3 bg-panel rounded border border-secondary">
                        <h6 class="text-muted small mb-3">Attack Vector Analysis</h6>
                        <div style="height:250px;"><canvas id="chartTypes"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-network" class="dashboard-section" style="display:none; height: 85vh; position: relative;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="font-monospace"><i class="fa-solid fa-globe text-info me-2"></i>THREAT TOPOLOGY <span class="badge bg-dark border border-info ms-2 font-monospace" id="map-agent-badge">SELECT AGENT</span></h4>
                <button class="btn btn-outline-light btn-sm" onclick="switchView('dashboard')"><i class="fa-solid fa-xmark me-2"></i>CLOSE MAP</button>
            </div>
            <div id="mynetwork" style="width: 100%; height: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 8px;"></div>
            
            <div class="position-absolute bottom-0 start-0 m-3 p-3 bg-black bg-opacity-75 rounded border border-secondary" style="max-width: 250px;">
                <small class="text-muted d-block mb-2 font-monospace fw-bold">LEGEND</small>
                <div class="d-flex align-items-center mb-1"><span style="width:8px;height:8px;background:#10b981;border-radius:50%;margin-right:8px;"></span> Agent (Host)</div>
                <div class="d-flex align-items-center mb-1"><span style="width:8px;height:8px;background:#ef4444;border-radius:50%;margin-right:8px;"></span> External IP</div>
                <div class="d-flex align-items-center"><span style="width:8px;height:8px;background:#3b82f6;border-radius:2px;margin-right:8px;"></span> Local Process</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-dark border-secondary text-light">
                <div class="modal-header border-secondary bg-black bg-opacity-50">
                    <h5 class="modal-title font-monospace" id="modalTitle"><i class="fa-solid fa-terminal me-2 text-success"></i>AGENT INSPECTOR</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-header pt-0 pb-0 border-secondary bg-black bg-opacity-25">
                    <ul class="nav nav-tabs border-0" id="reportTabs">
                        <li class="nav-item"><button class="nav-link active rounded-0 text-muted" data-bs-toggle="tab" data-bs-target="#processes-tab" onclick="loadReportView('processes')">PROCESSES</button></li>
                        <li class="nav-item"><button class="nav-link rounded-0 text-muted" data-bs-toggle="tab" data-bs-target="#ports-tab" onclick="loadReportView('ports')">PORTS</button></li>
                        <li class="nav-item"><button class="nav-link rounded-0 text-warning" data-bs-toggle="tab" data-bs-target="#audit-tab" onclick="loadReportView('audit')"><i class="fa-solid fa-clipboard-check me-2"></i>AUDIT</button></li>
                        <li class="nav-item"><button class="nav-link rounded-0 text-danger" data-bs-toggle="tab" data-bs-target="#actions-tab"><i class="fa-solid fa-radiation me-2"></i>ACTIONS</button></li>
                    </ul>
                </div>
                <div class="modal-body p-0 bg-black">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="processes-tab"><div id="processes-content" class="table-responsive"></div></div>
                        <div class="tab-pane fade" id="ports-tab"><div id="ports-content" class="table-responsive"></div></div>
                        <div class="tab-pane fade" id="audit-tab"><div id="audit-content" class="p-4 text-light font-monospace"></div></div>
                        <div class="tab-pane fade" id="actions-tab">
                            <div class="p-5 d-flex flex-column gap-3 align-items-center justify-content-center text-center">
                                <h5 class="text-danger font-monospace mb-4">⚠️ ACTIVE RESPONSE ZONE</h5>
                                <div class="d-flex gap-4">
                                    <button class="btn btn-outline-danger btn-lg p-4" onclick="confirmIsolation(true)">
                                        <div class="mb-2"><i class="fa-solid fa-network-wired fa-2x"></i></div><div>ISOLATE HOST</div>
                                    </button>
                                    <button class="btn btn-outline-success btn-lg p-4" onclick="confirmIsolation(false)">
                                        <div class="mb-2"><i class="fa-solid fa-rotate-left fa-2x"></i></div><div>RESTORE NET</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // CONFIGURATION: Relative path for deployment flexibility
        const API_BASE = "/api/v1";
        const REFRESH_RATE = 2000;
        
        let dataTable = null;
        let selectedAgentID = null;
        const modalInstance = new bootstrap.Modal(document.getElementById('reportModal'));

        document.addEventListener('DOMContentLoaded', () => {
            initDataTables();
            fetchDashboardData();
            setInterval(fetchDashboardData, REFRESH_RATE);
        });

        // --- NAVIGATION ---
        function switchView(viewName) {
            document.querySelectorAll('.dashboard-section').forEach(el => el.style.display = 'none');
            
            if (viewName === 'dashboard') {
                document.getElementById('view-dashboard').style.display = 'block';
                document.querySelectorAll('.nav-link-custom').forEach(n => n.classList.remove('active'));
                document.querySelector('.nav-link-custom:first-child').classList.add('active');
            } else if (viewName === 'network') {
                if (!selectedAgentID) {
                    Swal.fire("Selection Required", "Please select an agent from the list first.", "warning");
                    switchView('dashboard');
                    return;
                }
                document.getElementById('view-network').style.display = 'block';
                document.getElementById('map-agent-badge').innerText = selectedAgentID;
                loadNetworkTopology();
            }
        }

        // --- DATA TABLES ---
        function initDataTables() {
            dataTable = $('#incidents-table').DataTable({
                dom: 'rtip', pageLength: 8, order: [[0, 'desc']],
                language: { emptyTable: "No threats detected. System secure." }, // English
                columns: [
                    { data: 'received_at' }, { data: 'agent_id' }, { data: 'severity' }, { data: 'type' }, { data: 'message' }
                ],
                columnDefs: [
                    { targets: 0, render: d => `<span class="text-muted small font-monospace">${new Date(d).toLocaleTimeString()}</span>` },
                    { targets: 1, render: d => `<span class="fw-bold text-light"><i class="fa-solid fa-desktop me-1 text-secondary"></i>${d.replace('AGENT_', '')}</span>` },
                    { targets: 2, className: 'text-center', render: d => {
                        const m = {'CRITICAL':'badge-crit','WARNING':'badge-warn','INFO':'badge-info'};
                        return `<span class="badge-cyber ${m[d]||'bg-secondary'}">${d}</span>`;
                    }},
                    { targets: 3, className: 'text-center', render: d => {
                        const icons = {'YARA_DETECTION':'fa-biohazard text-danger', 'NET_DEFENSE':'fa-shield-halved text-info', 'FILE_MOD':'fa-file-pen text-warning'};
                        return `<i class="fa-solid ${icons[d] || 'fa-bell text-secondary'}"></i>`;
                    }},
                    { targets: 4, render: d => `<span class="text-light opacity-75">${d}</span>` }
                ]
            });
        }

        // --- API & UI UPDATES ---
        async function fetchDashboardData() {
            try {
                const res = await fetch(`${API_BASE}/dashboard`);
                if(!res.ok) throw new Error("API Offline");
                const data = await res.json();
                
                updateServerStatus(true);
                document.getElementById('kpi-agents').innerText = Object.keys(data.agents).length;
                document.getElementById('kpi-critical').innerText = data.recent_incidents.filter(i => i.severity === 'CRITICAL').length;
                renderAgentList(data.agents);
                
                // Only update table if data changed (naive check via timestamp)
                const logs = data.recent_incidents;
                const currentTop = dataTable.row(0).data();
                if(logs.length > 0 && (!currentTop || logs[0].received_at !== currentTop.received_at)){
                    dataTable.clear().rows.add(logs).draw(false);
                }
            } catch(e) { 
                console.error(e); 
                updateServerStatus(false); 
            }
        }

        function renderAgentList(agents) {
            const list = document.getElementById('agents-list');
            if(Object.keys(agents).length === 0) {
                list.innerHTML = `<div class="p-4 text-center border border-dashed border-secondary rounded text-muted small">No agents connected.<br>Waiting for beacons...</div>`;
                return;
            }
            list.innerHTML = "";
            for(const [id, info] of Object.entries(agents)) {
                // Agent considered offline if last seen > 30 seconds ago
                const lastSeenMs = new Date() - new Date(info.last_seen);
                const isOnline = lastSeenMs < 35000; 
                
                list.innerHTML += `
                <div class="agent-card ${isOnline?'online':'offline'} p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold font-monospace text-white">${info.hostname}</span>
                        ${isOnline ? '<i class="fa-solid fa-wifi text-success" title="Online"></i>' : '<i class="fa-solid fa-power-off text-danger" title="Offline"></i>'}
                    </div>
                    <div class="small text-muted mb-2 font-monospace">ID: ${id.replace('AGENT_', '')}</div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-light w-100" onclick="openInspector('${id}', '${info.hostname}')"><i class="fa-solid fa-magnifying-glass me-1"></i> INSPECT</button>
                    </div>
                </div>`;
            }
        }
        
        function updateServerStatus(online) {
            const el = document.getElementById('server-status-badge');
            el.className = online ? "badge bg-success shadow-sm font-monospace" : "badge bg-danger shadow-sm font-monospace";
            el.innerText = online ? "CONNECTED" : "DISCONNECTED";
        }

        // --- INSPECTOR MODAL ---
        function openInspector(id, host) {
            selectedAgentID = id;
            document.getElementById('modalTitle').innerText = `INSPECTOR: ${host}`;
            modalInstance.show();
            loadReportView('processes');
        }

        async function loadReportView(type) {
            const contentDiv = document.getElementById(type+'-content');
            contentDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success"></div><div class="mt-3 text-muted font-monospace small">Querying endpoint intelligence...</div></div>';
            
            // Map view type to command
            const cmdMap = { 'processes': 'REPORT_PROCESSES', 'ports': 'REPORT_PORTS', 'audit': 'RUN_AUDIT' };
            if (cmdMap[type]) triggerCommand(selectedAgentID, cmdMap[type]);
            
            // Artificial delay to allow agent to reply (in production, use websockets or polling)
            setTimeout(async () => {
                try {
                    const res = await fetch(`${API_BASE}/agent/${selectedAgentID}/${type}`);
                    const data = await res.json();

                    if (!data || (Array.isArray(data) && data.length === 0)) {
                        contentDiv.innerHTML = '<div class="alert alert-warning bg-opacity-10 border-0 text-center mx-3 my-3">No telemetry received yet. Agent might be sleeping.</div>';
                        return;
                    }
                    
                    renderReportContent(type, data, contentDiv);
                } catch(e) {
                    contentDiv.innerHTML = `<div class="text-center text-danger py-3">Error fetching report: ${e.message}</div>`;
                }
            }, 3000);
        }

        function renderReportContent(type, data, container) {
            if(type === 'processes') {
                let html = '<table class="table table-dark table-sm table-hover font-monospace small align-middle"><thead><tr><th>PID</th><th>NAME</th><th>USER</th><th>RISK</th><th>ACTION</th></tr></thead><tbody>';
                data.forEach(p => {
                    html += `<tr>
                        <td>${p.pid}</td>
                        <td class="${p.risk==='CRITICAL'?'text-danger fw-bold':''}">${p.name}</td>
                        <td>${p.username || 'System'}</td>
                        <td><span class="badge-cyber ${p.risk==='CRITICAL'?'badge-crit':(p.risk==='WARNING'?'badge-warn':'bg-secondary')}">${p.risk}</span></td>
                        <td><button class="btn btn-sm py-0 px-2 btn-outline-danger" onclick="triggerCommand('${selectedAgentID}','KILL:${p.pid}')">KILL</button></td>
                    </tr>`;
                });
                container.innerHTML = html + '</tbody></table>';
            } else if(type === 'ports') {
                let html = '<table class="table table-dark table-sm table-hover font-monospace small align-middle"><thead><tr><th>PORT</th><th>PROTO</th><th>BIND IP</th><th>SERVICE / RISK</th><th>PROCESS</th></tr></thead><tbody>';
                data.forEach(p => {
                    const isRisky = ['CRITICAL','HIGH'].includes(p.risk);
                    html += `<tr ${isRisky ? 'style="background: rgba(239, 68, 68, 0.05);"' : ''}>
                        <td class="fw-bold text-white">${p.port}</td>
                        <td>${p.proto}</td>
                        <td class="${p.ip_bind === '0.0.0.0' ? 'text-warning' : 'text-muted'}">${p.ip_bind || '*'}</td>
                        <td><span class="badge-cyber ${isRisky?'badge-crit':'badge-info'} me-2">${p.risk}</span>${p.service}</td>
                        <td><span class="text-info">${p.process}</span> <span class="text-secondary small">(${p.pid})</span></td>
                    </tr>`;
                });
                container.innerHTML = html + '</tbody></table>';
            } else if (type === 'audit') {
                 // Reuse previous audit HTML logic but translated
                 container.innerHTML = `<div class="p-3 text-white">
                    <h6>Firewall: ${data.firewall?.Overall || 'UNKNOWN'}</h6>
                    <pre class="small text-muted">${JSON.stringify(data, null, 2)}</pre>
                 </div>`;
            }
        }

        // --- NETWORK MAP ---
        async function loadNetworkTopology() {
            const container = document.getElementById('mynetwork');
            container.innerHTML = '<div class="text-center text-muted mt-5"><i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br>Mapping connections...</div>';
            triggerCommand(selectedAgentID, 'REPORT_NETWORK_MAP');

            setTimeout(async () => {
                try {
                    const res = await fetch(`${API_BASE}/agent/${selectedAgentID}/network_map`);
                    const connections = await res.json();
                    
                    if(!connections || connections.length === 0) {
                        container.innerHTML = '<div class="text-center text-secondary mt-5">No active network flows detected.</div>';
                        return;
                    }

                    const nodes = new vis.DataSet([{id: 'AGENT', label: 'HOST', color: '#10b981', size: 30, shape: 'dot', font: {color:'white'}}]);
                    const edges = new vis.DataSet([]);

                    connections.forEach(conn => {
                        const procId = `PROC_${conn.pid}`;
                        if(!nodes.get(procId)) nodes.add({id: procId, label: conn.process||'Unknown', color: '#3b82f6', shape: 'box', font:{color:'white'}});
                        edges.add({from: 'AGENT', to: procId, color: '#334155'});
                        
                        const remoteIp = conn.dst.split(':')[0];
                        const ipId = `IP_${remoteIp}`;
                        if(!nodes.get(ipId)) nodes.add({id: ipId, label: remoteIp, color: '#ef4444', shape: 'ellipse', font:{color:'white', size: 10}});
                        edges.add({from: procId, to: ipId, arrows: 'to', color: {color:'#64748b', opacity: 0.5}});
                    });

                    new vis.Network(container, {nodes, edges}, {
                        physics: { stabilization: false, barnesHut: { gravitationalConstant: -4000 } },
                        interaction: { hover: true }
                    });

                } catch(e) { container.innerHTML = `<div class="text-center text-danger mt-5">Map Error: ${e.message}</div>`; }
            }, 3000);
        }

        // --- ACTIONS ---
        async function triggerCommand(id, cmd) {
            try {
                await fetch(`${API_BASE}/admin/command`, { 
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({target_agent_id: id, command: cmd}) 
                });
            } catch(e) { console.error("Command failed", e); }
        }

        function confirmIsolation(isolate) {
            triggerCommand(selectedAgentID, isolate ? 'ISOLATE_HOST' : 'UNISOLATE_HOST');
            Swal.fire('Request Sent', isolate ? 'Initiating Network Isolation...' : 'Restoring Connectivity...', 'success');
        }

        function toggleCharts() { 
            const el = document.getElementById('chart-area');
            el.style.display = el.style.display === 'none' ? 'flex' : 'none'; 
        }
        
        async function logout() { 
            await fetch('/api/v1/auth/logout', {method:'POST'}); 
            window.location.href='/login'; 
        }
    </script>
</body>
</html>