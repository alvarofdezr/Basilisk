<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basilisk C2 | Enterprise SOC Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        :root { --bg-body: #0b1120; --bg-panel: #151e32; --bg-card: #1e293b; --accent-primary: #10b981; --accent-danger: #ef4444; --accent-warn: #f59e0b; --text-primary: #e2e8f0; --sidebar-width: 260px; }
        body { background-color: var(--bg-body); color: var(--text-primary); font-family: 'Inter', sans-serif; overflow-x: hidden; padding-left: var(--sidebar-width); }
        
        /* Layout & Sidebar */
        #sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; left: 0; top: 0; background: var(--bg-panel); border-right: 1px solid #334155; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
        .brand-logo { padding: 24px; background: linear-gradient(180deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%); border-bottom: 1px solid #334155; }
        .brand-title { font-family: 'JetBrains Mono', monospace; font-weight: 800; letter-spacing: -1px; color: var(--accent-primary); font-size: 1.4rem; }
        .nav-link-custom { padding: 14px 24px; color: #94a3b8; cursor: pointer; transition: all 0.3s; border-left: 3px solid transparent; font-weight: 500; }
        .nav-link-custom:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-link-custom.active { background: linear-gradient(90deg, rgba(16, 185, 129, 0.15), transparent); color: var(--accent-primary); border-left-color: var(--accent-primary); }
        
        #main-content { padding: 30px; }
        
        /* Dashboard Cards */
        .kpi-card { background: var(--bg-panel); border: 1px solid #334155; border-radius: 8px; position: relative; overflow: hidden; }
        .kpi-value { font-family: 'JetBrains Mono', monospace; font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .kpi-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; font-weight: 600; }
        
        /* Tables */
        #incidents-table_wrapper { padding: 0; background: transparent; }
        table.dataTable { border-collapse: separate; border-spacing: 0 4px; margin-top: 10px !important; }
        table.dataTable thead th { background: transparent; color: #64748b; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid #334155 !important; padding-bottom: 15px; }
        table.dataTable tbody tr { background-color: var(--bg-panel); transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table.dataTable tbody tr:hover { transform: scale(1.005); background-color: #1e293b; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        table.dataTable tbody td { border: none !important; padding: 12px 15px; vertical-align: middle; font-size: 0.9rem; }
        
        /* Badges & Indicators */
        .badge-cyber { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; padding: 5px 10px; border-radius: 4px; border: 1px solid transparent; }
        .badge-crit { background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.2); }
        .badge-warn { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border-color: #f59e0b; }
        .badge-info { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border-color: #3b82f6; }
        
        .agent-card { background: var(--bg-panel); border: 1px solid #334155; margin-bottom: 10px; border-radius: 8px; transition: 0.2s; }
        .agent-card:hover { border-color: var(--accent-primary); }
        .agent-card.online { border-left: 4px solid var(--accent-primary); }
        .agent-card.critical { border-left: 4px solid var(--accent-danger); }
        .icon-box { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="brand-logo">
            <div class="d-flex justify-content-between align-items-center">
                <span class="brand-title d-flex align-items-center">
                    <img src="/static/logo.ico" alt="Logo" style="height: 50px; width: auto; margin-right: 12px;"> BASILISK
                </span>
                <span class="badge bg-dark border border-success text-success font-monospace" style="font-size: 0.6rem;">v6.6.0</span>
            </div>
            <div class="text-success opacity-75 small mt-2" style="font-size: 0.7rem; letter-spacing: 1px;">ADVANCED THREAT DEFENSE</div>
        </div>
        <div class="mt-4">
            <div class="nav-link-custom active" onclick="closeNetworkMap()"><i class="fa-solid fa-grid-2 me-3"></i>Threat Feed</div>
            <div class="nav-link-custom" onclick="showNetworkMap()"><i class="fa-solid fa-network-wired me-3"></i>Network Map</div>
            <div class="nav-link-custom" onclick="Swal.fire('Audit Info', 'Select an agent to perform audit.', 'info')"><i class="fa-solid fa-file-contract me-3"></i>Compliance</div>
        </div>
        <div class="mt-auto p-4 border-top border-secondary bg-black bg-opacity-25">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <span class="small text-muted text-uppercase fw-bold">System Status</span>
                <span class="badge bg-danger shadow-sm" id="server-status-badge">DISCONNECTED</span>
            </div>
            <button class="btn btn-outline-danger btn-sm w-100" onclick="logout()"><i class="fa-solid fa-power-off me-2"></i>Cerrar Sesión</button>
        </div>
    </div>

    <div id="main-content">
        <div class="row g-4 mb-5 dashboard-view">
            <div class="col-md-3">
                <div class="p-4 kpi-card">
                    <div class="d-flex justify-content-between">
                        <div><div class="kpi-title">Agentes Activos</div><div class="kpi-value text-success mt-2" id="kpi-agents">0</div></div>
                        <div class="text-success opacity-25"><i class="fa-solid fa-server fa-2x"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-4 kpi-card">
                    <div class="d-flex justify-content-between">
                        <div><div class="kpi-title">Amenazas (24h)</div><div class="kpi-value text-danger mt-2" id="kpi-critical">0</div></div>
                        <div class="text-danger opacity-25"><i class="fa-solid fa-biohazard fa-2x"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-4 kpi-card">
                    <div class="d-flex justify-content-between">
                        <div><div class="kpi-title">Baseline FIM</div><div class="kpi-value text-info mt-2" id="kpi-fim">OK</div></div>
                        <div class="text-info opacity-25"><i class="fa-solid fa-file-shield fa-2x"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 d-grid">
                <button class="btn btn-outline-secondary border-dashed" id="toggle-charts-btn" onclick="toggleCharts()" style="border-style: dashed; border-width: 2px;">
                    <i class="fa-solid fa-chart-pie me-2"></i>Visualizar Métricas
                </button>
            </div>
        </div>

        <div class="row g-4 dashboard-view">
            <div class="col-md-3">
                <h6 class="text-muted text-uppercase mb-3 small fw-bold"><i class="fa-solid fa-laptop-code me-2"></i>Infraestructura</h6>
                <div id="agents-list" class="agent-list-container"></div>
            </div>

            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-muted text-uppercase small fw-bold mb-0 me-3"><i class="fa-solid fa-satellite-dish me-2"></i>Live Incident Feed</h6>
                    <button class="btn btn-outline-secondary btn-sm py-0 px-2" onclick="fetchDashboardData()" title="Force Update"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
                <table id="incidents-table" class="table" style="width:100%">
                    <thead><tr><th>Hora</th><th>Agente</th><th>Nivel</th><th>Tipo</th><th>Evento Detectado</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="network-map-view" style="display:none; height: 80vh; position: relative;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="font-monospace"><i class="fa-solid fa-globe text-info me-2"></i>THREAT MAP <span class="badge bg-dark border border-info ms-2" id="map-agent-badge">SELECCIONA UN AGENTE</span></h4>
                <div>
                    <button class="btn btn-outline-light btn-sm" onclick="closeNetworkMap()"><i class="fa-solid fa-xmark"></i> CERRAR MAPA</button>
                </div>
            </div>
            <div id="mynetwork" style="width: 100%; height: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 8px;"></div>
            <div class="position-absolute bottom-0 start-0 m-3 p-3 bg-black bg-opacity-75 rounded border border-secondary" style="max-width: 300px;">
                <small class="text-muted d-block mb-1">LEYENDA</small>
                <div class="d-flex align-items-center mb-1"><span style="width:10px;height:10px;background:#10b981;border-radius:50%;display:inline-block;margin-right:8px;"></span> Agente (Este PC)</div>
                <div class="d-flex align-items-center mb-1"><span style="width:10px;height:10px;background:#ef4444;border-radius:50%;display:inline-block;margin-right:8px;"></span> Conexión Externa</div>
                <div class="d-flex align-items-center"><span style="width:10px;height:10px;background:#3b82f6;border-radius:50%;display:inline-block;margin-right:8px;"></span> Proceso Local</div>
            </div>
        </div>

        <div class="row g-4 mt-2 dashboard-view" id="chart-area" style="display:none;">
             <div class="col-md-12"><hr class="border-secondary opacity-25"></div>
            <div class="col-md-4">
                <div class="card-custom p-3" style="background:var(--bg-panel); border-radius:8px;">
                    <h6 class="text-muted small">Severidad de Amenazas</h6>
                    <div style="height:250px;"><canvas id="chartSeverity"></canvas></div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card-custom p-3" style="background:var(--bg-panel); border-radius:8px;">
                    <h6 class="text-muted small">Top Vectores de Ataque</h6>
                    <div style="height:250px;"><canvas id="chartTypes"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-dark border-secondary text-light">
                <div class="modal-header border-secondary bg-black bg-opacity-50">
                    <h5 class="modal-title font-monospace" id="modalTitle"><i class="fa-solid fa-terminal me-2 text-success"></i>AGENT INSPECTOR</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-header pt-0 pb-0 border-secondary bg-black bg-opacity-25">
                    <ul class="nav nav-tabs border-0" id="reportTabs">
                        <li class="nav-item"><button class="nav-link active rounded-0 text-muted" data-bs-toggle="tab" data-bs-target="#processes-tab-pane" onclick="loadReportView('processes')">PROCESSES</button></li>
                        <li class="nav-item"><button class="nav-link rounded-0 text-muted" data-bs-toggle="tab" data-bs-target="#ports-tab-pane" onclick="loadReportView('ports')">PORTS</button></li>
                        <li class="nav-item"><button class="nav-link rounded-0 text-warning" data-bs-toggle="tab" data-bs-target="#audit-tab-pane" onclick="loadReportView('audit')"><i class="fa-solid fa-clipboard-check me-2"></i>AUDIT</button></li>
                        <li class="nav-item"><button class="nav-link rounded-0 text-danger" data-bs-toggle="tab" data-bs-target="#actions-tab-pane"><i class="fa-solid fa-radiation me-2"></i>ACTIONS</button></li>
                    </ul>
                </div>
                <div class="modal-body p-0 bg-black">
                    <div class="tab-content" id="reportTabsContent">
                        <div class="tab-pane fade show active" id="processes-tab-pane"><div id="processes-content" class="table-responsive"></div></div>
                        <div class="tab-pane fade" id="ports-tab-pane"><div id="ports-content" class="table-responsive"></div></div>
                        <div class="tab-pane fade" id="audit-tab-pane"><div id="audit-content" class="p-4 text-light font-monospace"></div></div>
                        <div class="tab-pane fade" id="actions-tab-pane">
                            <div class="p-4 d-flex flex-column gap-3 align-items-center justify-content-center text-center">
                                <h5 class="text-danger font-monospace mb-4">⚠️ ACTIVE RESPONSE ZONE</h5>
                                <div class="d-flex gap-4">
                                    <button class="btn btn-outline-danger btn-lg p-4 border-2" onclick="confirmIsolation(true)">
                                        <div class="mb-2"><i class="fa-solid fa-network-wired fa-2x"></i></div><div>ISOLATE HOST</div>
                                    </button>
                                    <button class="btn btn-outline-success btn-lg p-4 border-2" onclick="confirmIsolation(false)">
                                        <div class="mb-2"><i class="fa-solid fa-rotate-left fa-2x"></i></div><div>RESTORE NET</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        const API_BASE = "https://localhost:8443/api/v1";
        const REFRESH_RATE = 2000;
        let dataTable = null;
        let selectedAgentID = null;
        const modalInstance = new bootstrap.Modal(document.getElementById('reportModal'));

        document.addEventListener('DOMContentLoaded', () => {
            initDataTables();
            fetchDashboardData();
            setInterval(fetchDashboardData, REFRESH_RATE);
        });

        // --- DASHBOARD DATA ---
        function initDataTables() {
            dataTable = new $('#incidents-table').DataTable({
                dom: 'rtip', pageLength: 8, order: [[0, 'desc']],
                language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
                columns: [
                    { data: 'received_at' }, { data: 'agent_id' }, { data: 'severity' }, { data: 'type' }, { data: 'message' }
                ],
                columnDefs: [
                    { targets: 0, render: d => `<span class="text-muted small font-monospace">${new Date(d).toLocaleTimeString()}</span>` },
                    { targets: 1, render: d => `<span class="agent-id-tag"><i class="fa-solid fa-desktop me-1"></i>${d.replace('AGENT_', '')}</span>` },
                    { targets: 2, className: 'text-center', render: d => {
                        const m = {'CRITICAL':'badge-crit','WARNING':'badge-warn','INFO':'badge-info'};
                        return `<span class="badge-cyber ${m[d]||'bg-secondary'}">${d}</span>`;
                    }},
                    { targets: 3, className: 'text-center', render: d => {
                        const i = {'YARA_DETECTION':'fa-biohazard text-danger', 'NET_DEFENSE':'fa-shield-halved text-info', 'FILE_MOD':'fa-file-pen text-warning'};
                        const cls = i[d] || 'fa-bell text-secondary';
                        return `<div class="icon-box"><i class="fa-solid ${cls}"></i></div>`;
                    }},
                    { targets: 4, render: d => `<span class="log-msg">${d}</span>` }
                ]
            });
        }

        async function fetchDashboardData() {
            try {
                const res = await fetch(`${API_BASE}/dashboard`);
                const data = await res.json();
                updateServerStatus(true);
                document.getElementById('kpi-agents').innerText = Object.keys(data.agents).length;
                document.getElementById('kpi-critical').innerText = data.recent_incidents.filter(i => i.severity === 'CRITICAL').length;
                renderAgentList(data.agents);
                
                const logs = data.recent_incidents;
                if(logs.length > 0 && (!dataTable.row(0).data() || logs[0].received_at !== dataTable.row(0).data().received_at)){
                    dataTable.clear().rows.add(logs).draw(false);
                }
            } catch(e) { console.error(e); updateServerStatus(false); }
        }

        function renderAgentList(agents) {
            const list = document.getElementById('agents-list');
            if(Object.keys(agents).length === 0) {
                list.innerHTML = `<div class="p-3 text-center border border-dashed rounded text-muted">Searching for agents...</div>`;
                return;
            }
            list.innerHTML = "";
            for(const [id, info] of Object.entries(agents)) {
                const isActive = (new Date() - new Date(info.last_seen)) < 5000;
                list.innerHTML += `
                <div class="agent-card ${isActive?'online':'critical'} p-3">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold font-monospace text-white">${info.hostname}</span>
                        ${isActive ? '<i class="fa-solid fa-wifi text-success"></i>' : '<i class="fa-solid fa-slash text-danger"></i>'}
                    </div>
                    <div class="small text-muted mb-2 font-monospace">${id.replace('AGENT_', '')}</div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-dark w-100" onclick="openReport('${id}', '${info.hostname}')">INSPECT</button>
                    </div>
                </div>`;
            }
        }
        
        function updateServerStatus(online) {
            const b = document.getElementById('server-status-badge');
            b.className = online ? "badge bg-success shadow-sm" : "badge bg-danger shadow-sm";
            b.innerHTML = online ? "ONLINE" : "OFFLINE";
        }

        // --- REPORTING SYSTEM ---
        function openReport(id, host) {
            selectedAgentID = id;
            document.getElementById('modalTitle').innerText = `INSPECTOR: ${host}`;
            modalInstance.show();
            loadReportView('processes'); // Default view
        }

        async function loadReportView(type) {
            const area = document.getElementById(type+'-content');
            area.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-success"></div><div class="mt-2 text-muted font-monospace">Querying agent intelligence...</div></div>';
            
            // Determine correct command
            let cmd = 'REPORT_PROCESSES';
            if (type === 'ports') cmd = 'REPORT_PORTS';
            if (type === 'audit') cmd = 'RUN_AUDIT';
            
            triggerCommand(selectedAgentID, cmd);
            
            // Wait for agent response
            setTimeout(async () => {
                try {
                    const res = await fetch(`${API_BASE}/agent/${selectedAgentID}/${type}`);
                    if (!res.ok) throw new Error("Fetch failed");
                    const data = await res.json();

                    if (!data || (Array.isArray(data) && data.length === 0)) {
                        area.innerHTML = '<div class="alert alert-warning border-0 bg-opacity-10 text-center">No data received. Agent might be busy.</div>';
                        return;
                    }

                    // 1. PROCESS VIEW
                    if(type === 'processes') {
                        let h = '<table class="table table-dark table-sm table-hover font-monospace small"><thead><tr><th>PID</th><th>NAME</th><th>USER</th><th>RISK</th><th>ACTION</th></tr></thead><tbody>';
                        data.forEach(p => {
                            h += `<tr>
                                <td>${p.pid}</td>
                                <td class="${p.risk==='CRITICAL'?'text-danger fw-bold':''}">${p.name}</td>
                                <td>${p.username || '?'}</td>
                                <td><span class="badge-cyber ${p.risk==='CRITICAL'?'badge-crit':(p.risk==='WARNING'?'badge-warn':'bg-secondary')}">${p.risk}</span></td>
                                <td><button class="btn btn-xs btn-outline-danger" onclick="triggerCommand('${selectedAgentID}','KILL:${p.pid}')">KILL</button></td>
                            </tr>`;
                        });
                        area.innerHTML = h + '</tbody></table>';
                    } 
                    // 2. PORT INTELLIGENCE VIEW
                    else if(type === 'ports') {
                        let h = '<table class="table table-dark table-sm table-hover font-monospace small"><thead><tr><th>PORT</th><th>PROTO</th><th>BIND IP</th><th>SERVICE / RISK</th><th>PROCESS</th></tr></thead><tbody>';
                        data.forEach(p => {
                            let badgeClass = 'bg-secondary';
                            let rowClass = '';
                            
                            if (p.risk === 'CRITICAL' || p.risk === 'HIGH') {
                                badgeClass = 'badge-crit';
                                rowClass = 'style="background: rgba(239, 68, 68, 0.05);"';
                            } else if (p.risk === 'WARNING') {
                                badgeClass = 'badge-warn';
                            } else if (p.risk === 'INFO') {
                                badgeClass = 'badge-info';
                            }

                            let icon = p.proto === 'UDP' ? '<i class="fa-solid fa-paper-plane text-muted me-1"></i>' : '<i class="fa-solid fa-handshake text-muted me-1"></i>';

                            h += `<tr ${rowClass}>
                                <td class="fw-bold text-white">${p.port}</td>
                                <td>${icon}${p.proto}</td>
                                <td class="${p.ip_bind === '0.0.0.0' || p.ip_bind === '::' ? 'text-danger fw-bold' : 'text-muted'}">${p.ip_bind || '*'}</td>
                                <td><span class="badge-cyber ${badgeClass} me-2">${p.risk}</span><span class="text-light">${p.service}</span></td>
                                <td><span class="text-info">${p.process}</span> <span class="text-secondary small ms-1">(${p.pid})</span></td>
                            </tr>`;
                        });
                        area.innerHTML = h + '</tbody></table>';
                    }
                    // 3. AUDIT & COMPLIANCE VIEW
                    else if (type === 'audit') {
                        let fw = data.firewall || {};
                        let fwBadge = fw.Overall === 'SECURE' ? 'bg-success' : 'bg-danger';
                        
                        let h = `
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="p-3 border border-secondary rounded bg-dark">
                                    <h6 class="text-uppercase text-muted mb-3"><i class="fa-solid fa-fire me-2"></i>Firewall Status</h6>
                                    <div class="d-flex justify-content-between mb-2"><span>Domain Profile:</span> <span class="${fw.Domain==='ACTIVE'?'text-success':'text-danger'}">${fw.Domain}</span></div>
                                    <div class="d-flex justify-content-between mb-2"><span>Private/Standard:</span> <span class="${fw.Standard==='ACTIVE'?'text-success':'text-danger'}">${fw.Standard}</span></div>
                                    <div class="d-flex justify-content-between"><span>Public Profile:</span> <span class="${fw.Public==='ACTIVE'?'text-success':'text-danger'}">${fw.Public}</span></div>
                                    <hr class="border-secondary"><span class="badge ${fwBadge} w-100 py-2">OVERALL: ${fw.Overall}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 border border-secondary rounded bg-dark">
                                    <h6 class="text-uppercase text-muted mb-3"><i class="fa-solid fa-shield-halved me-2"></i>System Hardening</h6>
                                    <div class="mb-3"><label class="small text-secondary">UAC (User Account Control)</label><div class="fw-bold ${data.uac.includes('ENABLED')?'text-success':'text-danger'}">${data.uac}</div></div>
                                    <div class="mb-3"><label class="small text-secondary">Windows Defender</label><div class="fw-bold ${data.defender==='ACTIVE'?'text-success':'text-danger'}">${data.defender}</div></div>
                                    <div><label class="small text-secondary">Last Windows Update</label><div class="text-info">${data.last_update}</div></div>
                                </div>
                            </div>
                            <div class="col-12 text-center mt-4"><small class="text-muted">Report generated at: ${data.scan_time}</small></div>
                        </div>`;
                        area.innerHTML = h;
                    }

                } catch(e) {
                    console.error(e);
                    area.innerHTML = `<div class="text-center text-danger py-3">Error processing report: ${e.message}</div>`;
                }
            }, 3500);
        }

        // --- NETWORK MAP VISUALIZATION ---
        function showNetworkMap() {
            if(!selectedAgentID) {
                Swal.fire("Selection Required", "Please select an agent from the Inspector first.", "warning");
                return;
            }
            document.querySelectorAll('.dashboard-view').forEach(e => e.style.display = 'none');
            document.getElementById('network-map-view').style.display = 'block';
            document.getElementById('map-agent-badge').innerText = selectedAgentID;
            loadNetworkTopology();
        }

        function closeNetworkMap() {
            document.getElementById('network-map-view').style.display = 'none';
            document.querySelectorAll('.dashboard-view').forEach(e => e.style.display = 'flex');
            document.getElementById('chart-area').style.display = 'none'; // Keep charts hidden by default
        }

        async function loadNetworkTopology() {
            const container = document.getElementById('mynetwork');
            container.innerHTML = '<div class="text-center text-muted mt-5"><i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br>Scanning global connections...</div>';

            triggerCommand(selectedAgentID, 'REPORT_NETWORK_MAP');

            setTimeout(async () => {
                try {
                    const res = await fetch(`${API_BASE}/agent/${selectedAgentID}/network_map`);
                    const connections = await res.json();

                    if(!connections || connections.length === 0) {
                        container.innerHTML = '<div class="text-center text-warning mt-5">No active connections reported.</div>';
                        return;
                    }

                    const nodes = new vis.DataSet([]);
                    const edges = new vis.DataSet([]);
                    
                    // Central Agent Node
                    nodes.add({id: 'AGENT', label: 'THIS PC', color: '#10b981', size: 30, shape: 'dot', font: {color:'white'}});

                    connections.forEach((conn) => {
                        // Process Node
                        const procId = `PROC_${conn.pid}`;
                        if(!nodes.get(procId)) {
                            nodes.add({
                                id: procId, 
                                label: conn.process || `PID ${conn.pid}`, 
                                color: '#3b82f6', 
                                shape: 'box',
                                font: {color:'white', size: 12}
                            });
                            edges.add({from: 'AGENT', to: procId, color: '#334155'});
                        }

                        // Remote IP Node
                        const remoteIp = conn.dst.split(':')[0];
                        const destId = `IP_${remoteIp}`;
                        
                        if(!nodes.get(destId)) {
                            nodes.add({
                                id: destId, 
                                label: remoteIp, 
                                color: '#ef4444', 
                                shape: 'ellipse', 
                                font: {color:'white', size: 10}
                            });
                        }
                        
                        edges.add({
                            from: procId, 
                            to: destId, 
                            label: conn.dst.split(':')[1],
                            font: {align: 'middle', size: 9, strokeWidth: 0},
                            arrows: 'to',
                            color: {color:'#64748b'}
                        });
                    });

                    const data = { nodes: nodes, edges: edges };
                    const options = {
                        physics: { stabilization: false, barnesHut: { gravitationalConstant: -8000 } },
                        layout: { randomSeed: 2 },
                        interaction: { hover: true }
                    };
                    new vis.Network(container, data, options);

                } catch(e) {
                    console.error(e);
                    container.innerHTML = '<div class="text-center text-danger mt-5">Visualization Error.</div>';
                }
            }, 3500);
        }

        async function triggerCommand(id, cmd) {
            try {
                await fetch(`${API_BASE}/admin/command`, { 
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({target_agent_id: id, command: cmd}) 
                });
            } catch(e) { console.error("Command failed", e); }
        }

        function confirmIsolation(isolate) {
            const action = isolate ? 'ISOLATE_HOST' : 'UNISOLATE_HOST';
            triggerCommand(selectedAgentID, action);
            Swal.fire('Command Sent', 'Agent will process request shortly.', 'success');
        }

        function toggleCharts() { document.getElementById('chart-area').style.display = 'flex'; }
        async function logout() { await fetch('/api/v1/auth/logout', {method:'POST'}); window.location.href='/login'; }

    </script>
</body>
</html>