<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PySentinel C2 | Enterprise Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* Enterprise Dark Theme Palette */
            --bg-body: #0f172a;       /* Slate 900 */
            --bg-panel: #1e293b;      /* Slate 800 */
            --bg-card: #334155;       /* Slate 700 */
            --text-primary: #f8fafc;  /* Slate 50 */
            --text-muted: #94a3b8;    /* Slate 400 */
            --accent-primary: #3b82f6; /* Blue 500 */
            --accent-danger: #ef4444;  /* Red 500 */
            --accent-warning: #f59e0b; /* Amber 500 */
            --accent-success: #22c55e; /* Green 500 */
            --sidebar-width: 260px;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            background: var(--bg-panel);
            border-right: 1px solid var(--bg-card);
            display: flex; flex-direction: column;
            z-index: 1000;
        }
        .brand-logo {
            padding: 24px;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            border-bottom: 1px solid var(--bg-card);
            letter-spacing: 1px;
        }
        .nav-link-custom {
            padding: 14px 24px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            display: flex; align-items: center;
        }
        .nav-link-custom:hover, .nav-link-custom.active {
            background: rgba(59, 130, 246, 0.08);
            color: white;
            border-left-color: var(--accent-primary);
        }

        /* --- MAIN LAYOUT --- */
        #main-wrapper {
            margin-left: var(--sidebar-width);
            padding: 30px;
            width: calc(100% - var(--sidebar-width));
        }

        /* --- CARDS & PANELS --- */
        .card-custom {
            background: var(--bg-panel);
            border: 1px solid var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card-header-custom {
            background: rgba(0,0,0,0.2);
            padding: 15px 20px;
            border-bottom: 1px solid var(--bg-card);
            font-weight: 600;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- AGENT LIST --- */
        .agent-list-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 5px;
        }
        .agent-card {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--text-muted); /* Default offline */
            transition: transform 0.2s;
        }
        .agent-card.online { border-left-color: var(--accent-success); }
        .agent-card:hover { transform: translateX(4px); }

        /* --- TERMINAL LOGS --- */
        .console-terminal {
            background: #000000;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            height: 550px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            color: #d4d4d4;
        }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #222; padding-bottom: 4px; }
        .log-time { color: #569cd6; margin-right: 8px; }
        .log-critical { color: #f44336; font-weight: bold; }
        .log-warning { color: #ff9800; }
        .log-info { color: #4caf50; }

        /* --- SCROLLBARS --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--bg-card); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="brand-logo">
            <i class="fa-solid fa-shield-halved text-primary me-2"></i>PySentinel
        </div>
        <div class="mt-2">
            <div class="nav-link-custom active"><i class="fa-solid fa-chart-line me-3"></i>Dashboard</div>
            <div class="nav-link-custom"><i class="fa-solid fa-sitemap me-3"></i>Topology</div>
            <div class="nav-link-custom"><i class="fa-solid fa-file-contract me-3"></i>Audit Logs</div>
            <div class="nav-link-custom"><i class="fa-solid fa-sliders me-3"></i>Settings</div>
        </div>
        <div class="mt-auto p-4 border-top border-secondary">
            <div class="d-flex align-items-center justify-content-between">
                <span class="small text-muted">Server Status</span>
                <span class="badge bg-danger" id="server-status-badge">OFFLINE</span>
            </div>
        </div>
    </div>

    <div id="main-wrapper">
        <div class="row g-4">
            
            <div class="col-xl-3 col-lg-4">
                <h5 class="text-white mb-3"><i class="fa-solid fa-network-wired me-2"></i>Active Agents</h5>
                <div id="agents-list" class="agent-list-container">
                    <div class="text-center mt-5 text-muted">
                        <div class="spinner-border spinner-border-sm mb-2"></div>
                        <p>Scanning for agents...</p>
                    </div>
                </div>
            </div>

            <div class="col-xl-6 col-lg-5">
                <div class="card-custom h-100">
                    <div class="card-header-custom">
                        <span><i class="fa-solid fa-terminal text-success me-2"></i>Live Security Feed</span>
                        <button class="btn btn-sm btn-outline-secondary border-0" onclick="fetchDashboardData()"><i class="fa-solid fa-rotate"></i></button>
                    </div>
                    <div id="logs-console" class="console-terminal">
                        </div>
                </div>
            </div>

            <div class="col-xl-3 col-lg-3">
                
                <div class="card-custom mb-4">
                    <div class="card-header-custom">Threat Levels</div>
                    <div class="card-body">
                        <div style="height: 200px; position: relative;">
                            <canvas id="chartSeverity"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card-custom">
                    <div class="card-header-custom">Response Actions</div>
                    <div class="card-body d-grid gap-2">
                        <button class="btn btn-outline-danger btn-sm text-start" onclick="globalAlert()">
                            <i class="fa-solid fa-bullhorn me-2"></i>Broadcast Alert
                        </button>
                        <button class="btn btn-outline-warning btn-sm text-start">
                            <i class="fa-solid fa-lock me-2"></i>Lockdown Mode (Beta)
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-white" id="modalTitle">Report Inspector</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="modal-loader" class="text-center py-5 d-none">
                        <div class="spinner-border text-primary"></div>
                    </div>
                    <div id="modal-content" class="table-responsive"></div>
                </div>
                <div class="modal-footer border-secondary bg-black">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary btn-sm" onclick="refreshCurrentReport()">Refresh Data</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // CONFIGURATION
        const API_BASE = "http://127.0.0.1:8000/api/v1";
        const REFRESH_RATE = 2000; // 2 seconds
        
        // STATE
        let chartInstance = null;
        let selectedAgent = null;
        let selectedReportType = null;
        const modalInstance = new bootstrap.Modal(document.getElementById('reportModal'));

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            startPolling();
        });

        function startPolling() {
            fetchDashboardData();
            setInterval(fetchDashboardData, REFRESH_RATE);
        }

        // --- API & DATA FETCHING ---
        async function fetchDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/dashboard`);
                if (!response.ok) throw new Error("Server Error");
                
                const data = await response.json();
                updateServerStatus(true);
                renderAgentList(data.agents);
                renderLogs(data.recent_incidents);
                updateChart(data.recent_incidents);
            } catch (error) {
                console.error("Connection lost:", error);
                updateServerStatus(false);
            }
        }

        function updateServerStatus(isOnline) {
            const badge = document.getElementById('server-status-badge');
            if (isOnline) {
                badge.className = "badge bg-success";
                badge.innerText = "ONLINE";
            } else {
                badge.className = "badge bg-danger";
                badge.innerText = "DISCONNECTED";
            }
        }

        // --- RENDERING AGENTS ---
        function renderAgentList(agents) {
            const container = document.getElementById('agents-list');
            
            if (Object.keys(agents).length === 0) {
                if(!container.innerHTML.includes("Scanning")) {
                    container.innerHTML = `<div class="text-center text-muted mt-5"><i class="fa-solid fa-ghost fa-2x mb-3"></i><br>No agents connected</div>`;
                }
                return;
            }

            // Simple diffing could be added here, but for now we rebuild safely
            let html = "";
            for (const [id, info] of Object.entries(agents)) {
                // Parse timestamp to see if active recently (optional logic)
                const isOnline = true; // Simplified for this version
                
                html += `
                <div class="agent-card ${isOnline ? 'online' : ''}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong class="text-white"><i class="fa-brands fa-windows me-1"></i> ${info.hostname}</strong>
                        <span class="badge bg-success" style="font-size:0.7rem">ACTIVE</span>
                    </div>
                    <div class="text-muted small mb-3" style="font-family:monospace">${id}</div>
                    
                    <div class="btn-group w-100 mb-2" role="group">
                        <button class="btn btn-sm btn-outline-light" onclick="openReport('${id}', 'processes')">Processes</button>
                        <button class="btn btn-sm btn-outline-light" onclick="openReport('${id}', 'ports')">Ports</button>
                    </div>
                    <button class="btn btn-sm btn-primary w-100" onclick="triggerAdminCommand('${id}', 'CREATE_BASELINE')">
                        <i class="fa-solid fa-camera me-1"></i> FIM Snapshot
                    </button>
                </div>`;
            }
            container.innerHTML = html;
        }

        // --- RENDERING LOGS ---
        function renderLogs(logs) {
            const container = document.getElementById('logs-console');
            // Reverse to show newest at bottom if we were appending, 
            // but for a feed usually newest is at top or bottom depending on preference.
            // Let's keep newest at top for visibility.
            const sortedLogs = logs.slice().reverse(); 

            const html = sortedLogs.map(log => {
                const ts = new Date(log.received_at).toLocaleTimeString();
                let colorClass = 'text-light';
                let icon = 'fa-circle-info';
                
                if (log.severity === 'CRITICAL') { colorClass = 'log-critical'; icon = 'fa-skull'; }
                else if (log.severity === 'WARNING') { colorClass = 'log-warning'; icon = 'fa-triangle-exclamation'; }
                else if (log.severity === 'INFO') { colorClass = 'log-info'; }

                return `
                <div class="log-entry">
                    <span class="log-time">[${ts}]</span>
                    <span class="${colorClass}"><i class="fa-solid ${icon} me-1"></i>${log.type}</span>: 
                    <span class="text-white">${log.message}</span>
                </div>`;
            }).join('');
            
            if (container.innerHTML !== html) {
                container.innerHTML = html;
            }
        }

        // --- CHARTING ---
        function initChart() {
            const ctx = document.getElementById('chartSeverity').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Info', 'Warning', 'Critical'],
                    datasets: [{
                        data: [1, 0, 0], // Placeholder
                        backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 10 } }
                    },
                    cutout: '75%'
                }
            });
        }

        function updateChart(logs) {
            if (!logs || logs.length === 0) return;
            
            let info = 0, warn = 0, crit = 0;
            logs.forEach(l => {
                if (l.severity === 'CRITICAL') crit++;
                else if (l.severity === 'WARNING') warn++;
                else info++;
            });
            
            // Avoid empty chart visual
            if (info + warn + crit === 0) info = 1;

            chartInstance.data.datasets[0].data = [info, warn, crit];
            chartInstance.update();
        }

        // --- COMMANDS & ACTIONS ---
        async function triggerCommand(agentId, commandPayload) {
            try {
                await fetch(`${API_BASE}/admin/command`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        target_agent_id: agentId,
                        command: commandPayload
                    })
                });
                
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, 
                    timer: 3000, background: '#1e293b', color: '#fff'
                });
                Toast.fire({ icon: 'success', title: 'Command Sent' });
            } catch (e) {
                Swal.fire({icon: 'error', title: 'Error', text: 'Failed to send command'});
            }
        }

        async function triggerAdminCommand(agentId, cmdType) {
            if (cmdType === 'CREATE_BASELINE') {
                const { value: password } = await Swal.fire({
                    title: 'Admin Authorization',
                    input: 'password',
                    inputLabel: 'Enter admin password to update Baseline',
                    inputPlaceholder: 'Password',
                    background: '#1e293b', color: '#fff',
                    confirmButtonColor: '#3b82f6'
                });

                if (password) {
                    triggerCommand(agentId, { cmd: cmdType, auth: password });
                }
            }
        }

        function globalAlert() {
            // Demo implementation
            Swal.fire({
                title: 'Broadcast Alert',
                text: 'This feature will send a popup to all agents.',
                icon: 'warning',
                background: '#1e293b', color: '#fff'
            });
        }

        // --- REPORTS (MODAL) ---
        async function openReport(agentId, type) {
            selectedAgent = agentId;
            selectedReportType = type === 'processes' ? 'REPORT_PROCESSES' : 'REPORT_PORTS';
            
            // 1. Request updated report from agent
            await triggerCommand(agentId, selectedReportType);
            
            // 2. Show Modal
            document.getElementById('modalTitle').innerText = `Live Report: ${type.toUpperCase()}`;
            document.getElementById('modal-loader').classList.remove('d-none');
            document.getElementById('modal-content').innerHTML = "";
            modalInstance.show();

            // 3. Poll for result (Wait 2s for agent to reply)
            setTimeout(refreshCurrentReport, 2500);
        }

        async function refreshCurrentReport() {
            if (!selectedAgent) return;
            
            const typeKey = selectedReportType === 'REPORT_PROCESSES' ? 'processes' : 'ports';
            document.getElementById('modal-loader').classList.remove('d-none');
            
            try {
                const res = await fetch(`${API_BASE}/agent/${selectedAgent}/${typeKey}`);
                const data = await res.json();
                
                document.getElementById('modal-loader').classList.add('d-none');
                
                if (data.length === 0) {
                    document.getElementById('modal-content').innerHTML = `<div class="p-4 text-center text-muted">Waiting for agent data... <br><button class="btn btn-link" onclick="refreshCurrentReport()">Try Again</button></div>`;
                    return;
                }

                if (typeKey === 'processes') renderProcessTable(data);
                else renderPortTable(data);

            } catch (e) {
                document.getElementById('modal-content').innerText = "Error loading data.";
            }
        }

        function renderProcessTable(data) {
            let html = `
            <table class="table table-dark table-hover table-sm" style="font-size:0.9rem">
                <thead>
                    <tr>
                        <th scope="col">PID</th>
                        <th scope="col">Name</th>
                        <th scope="col">Risk</th>
                        <th scope="col">Path</th>
                        <th scope="col">Action</th>
                    </tr>
                </thead>
                <tbody>`;
            
            data.forEach(p => {
                let riskClass = '';
                if(p.risk === 'CRITICAL') riskClass = 'text-danger fw-bold';
                else if(p.risk === 'WARNING') riskClass = 'text-warning';
                else if(p.risk === 'PRIVACY') riskClass = 'text-info';

                html += `
                <tr>
                    <td>${p.pid}</td>
                    <td class="${riskClass}">${p.name}</td>
                    <td>${p.risk}</td>
                    <td class="text-muted text-truncate" style="max-width: 200px;">${p.path}</td>
                    <td>
                        <button class="btn btn-outline-danger btn-sm py-0" style="font-size:0.7rem" onclick="triggerCommand('${selectedAgent}', 'KILL:${p.pid}')">KILL</button>
                    </td>
                </tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('modal-content').innerHTML = html;
        }

        function renderPortTable(data) {
            let html = `
            <table class="table table-dark table-hover table-sm">
                <thead>
                    <tr>
                        <th>Port</th>
                        <th>Proto</th>
                        <th>Service</th>
                        <th>Process</th>
                        <th>PID</th>
                    </tr>
                </thead>
                <tbody>`;
            
            data.forEach(p => {
                html += `
                <tr>
                    <td class="text-warning fw-bold">${p.port}</td>
                    <td>${p.proto}</td>
                    <td class="text-info">${p.service}</td>
                    <td>${p.process || '?'}</td>
                    <td>${p.pid}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('modal-content').innerHTML = html;
        }

    </script>
</body>
</html>